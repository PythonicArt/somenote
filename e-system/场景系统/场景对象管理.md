# 场景对象管理

## 坐标的建立
坐标点：
像素坐标系， 由一定数量的像素点组成一个正方形坐标点
一张图划分为等大小的坐标点， 根据长宽的坐标点数确定长度和宽度
模型格子
一个模型格子容纳一个对象， 对象的移动就是在格子之间跳动
一个模型格子内是一个坐标点的集合， 以一个点为中心， 一定范围内组成一个格子， 属于这个格子的所有坐标点都可以转化成这个中心点

格子
规定 格子的长度(模型格子的数量), 把地图划分为 等大小的格子，不一定是正方形， 进行编号

格子编号
    通过坐标点可以唯一确定格子的编号， 同理， 通过格子的序号也能确定改个字的坐标范围

视野
    由格子组成的正方形， 略大于整个屏幕
    九宫格 3*3 的九个格子组成一个正方形区域， 作为玩家的视野。
    在这个视野内的所有对象的数据都需要被获取

视野刷新, 当视野内的某个对象信息发生变化， 这个视野的数据需要刷新
比如某个地方下雪， 场景内每个对象都应该知道这里下雪， 同步播放效果

区域的划分
    二维坐标 可以声明一个01的矩阵模拟一个地图， 0不可进入1可进入 2(其他)
    三维坐标
        根据类型划分不同的集合， 通过配置读取， 节点启动时进行初始化

## 地图的预加载
需要一个进程管理每一个地图配置的坐标点
1. 不同类型区域的坐标点集合(可行区域， 安全区域， 攻击区域等)
2. 不同类型区域坐标点对应的 格子编号集合

## 格子内 map_elem的管理
每一个格子有自己格子内的对象元素, 以 格子编号 为key, 对应的value为这个集合 存于进程字典
map_elem的组成
```erlang
#map_elem{
    id = 对象唯一id
    origin_id = 对象原id
    elem_type =  对象类型
    pid = 原对象进程
    grid = 格子编号
}
```

## 场景内 map_object管理
```erlang
#map_object{
    object_id = 唯一id,
    origin_id = 原id
    object_type = 对象类型
    is_cross = 跨服状态
    base_attribute = 对象属性
    site = 位置
}
```
可以使用ets存储所有的对象，通过ets强大的匹配检索能力进行不同类型对象的组织和管理

## map_elem 和 map_object 的区别
前者用于 移动的控制， 主要反映位置信息
后者用于 战斗等计算， 主要反映状态信息


# 角色操作的流程
## 角色移动
```erlang
1. 生成map_object
2. 生成 map_elem
3. 场景刷新
    移动方向： 通过起点和终点格子编号比较得到
    对于玩家自身， 需要切换新位置的视野
    通知之前视野内的玩家自己离开， 通知新的视野自己进入;
    根据九个移动方向 确定以下类型的格子
        EnterGrids: 以此为中心格子的玩家， 会看到移动的角色进入
        LeaveGrids: 以此为中心格子的玩家， 会看到移动的角色离开
        MoveGrids : 以此为中心格子的玩家， 会看到角色移动

    P1 A B C
    P2 D E F
    P3 G H I

    玩家从E向D移动, 方向为左, 此时
    EnterGrids: 中心点 为 P1, P2, P3的玩家的会看到 移动的角色从屏幕右侧进入
    LeaveGrids: 中心点 为 C, F, I的玩家的会看到 移动的角色从屏幕左侧消失
    MoveGrids: 中心点 为 A, B, D, E, G, H的玩家的会看到 移动的角色在移动

    更新map_elem, 从旧的格子中删除自己, 在新的格子中加入自己

    通知LeaveGrids中的所有人, 自己离开， 并且收集这些玩家，这是移动的角色新的视野中不存在的对象， 需要删除
    通知EnterGrids中的所有人, 自己进入， 并且收集这些玩家，这是移动的角色新的视野中新加的对象， 需要新增

    根据以上两个集合， 通知自己刷新视野数据， 如果集合均为空， 则不许刷新

    以出发点为中心的九宫格内的所有场景对象都需要知道， 移动的角色开始移动， 没变换一次坐标就需要进行同步新的位置信息

    连续移动
    根据移动速度， 决定了移动操作的速度， 即调用移动函数的频率
    有寻路算法确定下一个经过的点， 没到达一个新的点， 就同步自己的坐标信息， 并且新的点成为新的出发点
    重复以上步骤, 直到停止移动， 同时视野刷新

```
