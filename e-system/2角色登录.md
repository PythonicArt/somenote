1. 所有系统进程启动后， 开启角色监控树根节点 role_sup.
```erlang
init([]) ->
    Child = {
        role_server,
        {role_server, start_link, []},
        temporary,
        200000,
        worker,
        [role_server]
    },
    {ok, {{simple_onoe_for_one, 10, 10}}, [Child]}.
```

2. game.app启动完毕后， 启动network.app,
    同登录节点类似, 监控树根节点  network_sup, 启动子节点network_accetp负责管理连接, 此时的连接来自角色的client
    1. 监听tcp端口, 获取ListenSock
    2. 当一个连接来临, 通过 role_sup, 开启role_server子进程接管当前连接, 同时监控该子进程。
        账号验证
            1. 服务器状态检查
            2. 时间有效性检查
            3. Token验证
                client根据字段生成的 CTS , 与server生成的 STS进行比较, 相同的通过
            4. 读取账号的角色, 传给client
            5. 将登陆状态设为  验证成功，完成验证

        角色首次登陆
            1. 角色检查, 是否存在或是否封禁. 此时应该不存在角色进程， 如果有记录， 则视为挤号登陆, 将连接交由旧进程， 通知那个进程角色重登， 当前进程退出
            2. 加载角色数据, 各模块初始化gen_mod
            3. 角色状态设置为 登陆初步完成, 给自己cast 登陆结束消息
            4. 收到登陆结束消息, 完成数据初始化. 将角色状态设置为登陆完成
                设置登陆时间， 角色数据跨天检查.

        角色重连
            重连的过程是新建了一个连接， 但是已经存在已有的角色进程.
            client 认为已经通过验证, 不再发验证消息， 而是直接发重连消息.
            找到旧的角色进程， 将连接交由此进程(老连接已经断掉)， 并通知其角色重连

        挤号登陆与重连的区别
            客户端的判定,
                客户端没有记录， 但是服务器有记录， 说明更换了客户端， 则为挤号
                客户端有记录， 服务器也有记录， 说明同一客户端重登， 则为断线重连

            挤号时， 有一些必要的信息客户端没有， 则需要重发, 这里类似第一次登陆， 而重连则不需操作

## client-server 的通信数据格式
1. 约定指定格式的数据  两个包为一个周期， 第一个包为下一个包的数据长度， 下一个包为数据的数据
    进程设置一个len标志， 初始为0， 当为0时则认为应该接收 长度包， 为n时应该接收长度为n的数据包

2. 数据协议的制定
    根据不同功能划分不同的section, 累增编号, 包含模块名称
    每个section下包含多个msg, 累增编号, 包含消息名称
    ```xml
    <section id=SectionId name=Name >
        <msg id=MsgId name=ModName>
            <c2s>
                <f t=Type name=TName/>
            </c2s>
            <s2s>
                <f loop=Type name=TName/>
            </s2s>
        </msg>
    </section>
    ```
    每个msg下包含0个或多个不同类型的数据字段, 当需要复合结构， 可以通过建立struct, 以便复用

3. 二进制数据传输
    ```erlang
        <<Uniq:?UNQI_SIZE, SectionId:?SECTION_SIZE, MsgId:?MSG_SIZE, RestBin/binary>>
        进程维护一个 UniqCount, 没收到一条协议自增， 用以保证确认收到的协议是增加的
        通过编号可以建立 msg <-> 协议解析函数的 的映射关系
        根据MsgId找到解析函数， 解析二进制协议, 得到erlnag record #xxx_c2s{}

    ```
