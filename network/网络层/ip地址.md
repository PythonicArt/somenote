接入网络的设备应该具有一个全球唯一的地址, 来做位置的识别

ip地址由两部分组成

网络号 主机号
同一网络内的ip地址网络号都相同

路由器通过网络号来转发数据, 一个路由器的条目, 就是网络号和对应的出口

同一网络内的数据通讯可以直接交付

不同网络内的通信， 通过连接多个网络的路由器进行间接交付， 即交给出口的路由器转发出去，收数据时通过这个路由器转发到具体的主机

一个主机可能会同时处于多个网络， 具有多个网络地址, 比如连接多个网络的路由器

总共32位
# 五类ip地址
特殊的网络号
    全0: 本网络, 不能分配作为网络号
    127: A类地址中的回环网络号
    局域网网段
        10.0.0.0 - 10.255.255.255
        172.16.0.0 - 172.31.255.255
        192.168.0.0 - 192.168.255.255

特殊的主机号
    全0: 本机所连接的网络地址
    全1: 广播地址, 拥有改地址的数据报 对被转发到当前网络的每一台主机


## ip地址与硬件地址的区别
1. ip地址是网络层及以上使用的地址， 是一种逻辑的划分, 使用软件实现的， 同一个主机可能会拥有不同的ip地址
2. 硬件地址是数据链路层和物理层使用的地址， 固化在网卡的rom中， 也叫MAC地址

同一网络的通信, 通过mac地址在数据链路层就可以交付

不同网络的通信， 通过交付到中间的路由器， 再转发到其他网络
路由器通过不同的端口 连接不同的网络， 每一个端口都相当于一个网卡， 都有自己的mac地址， 也有位于网络中的ip地址

# arp地址转换协议

发现一个目的ip地址, 通过arp协议找出mac地址或是转发路由的mac地址
同一网络中, ip与mac地址的转换, 即发现目的ip地址和自己是同一网络之后, 通过这个协议找到目的mac地址, 通过底层直接交付

## 协议流程
每台主机都维护一个缓存， 保存ip-mac地址的映射
当找不到的时候

1. 广播查询
    向网络内所有主机进行广播, 发送 arp 请求分组, 查询ipB的mac地址
    请求数据中包含自己的ip地址 ipA， 和mac地址 macA
    这样做的理由是，刷新地址， 避免B再重新请求A的地址信息

2. 当收到请求的主机发现是查询自己的地址时， 收下请求. 否则， 不理睬
    将请求中的源地址信息, 写入自己的缓存表中, 以最新的为准
    将自己的地址信息 单播 的方式 回给 ipA的主机
    而其他不匹配的主机则丢弃该查询分组

3. 收到响应之后， ipA的主机将数据写入缓存表

## 时效性
由于网络是动态变化的， 可能会删减主机， 或是变换地址
当发生变化的时候， 不立即广播更新， 而是让旧的数据保留一段时间， 在这段时间内， 主机会按照旧的地址传送数据
每一个条目设置一个生存时间, 当生存时间到达， 条目删除.继续通信时， 需要广播重新请求数据, 此时获得最新的地址信息, 更新缓存表


## 为什么不直接通过mac地址交互, 而需要频繁地进行ip-mac的索引转换呢 ?

这样需要将整个网络的设备当做一个整体考虑， 过于复杂和庞大， 不管是查询或是更新都是及其耗费时间的
通过网络来独立进行地址转换， 相当于逐一的简化问题

# 分组转发的流程

一个路由器可以同时连接多个网络
同一网络内的主机， 可以不经过路由器直接交付数据报
否则，需要通过路由器交付

特定路由
    某些网络的固定配置， 即将这些网络的流量导入到指定的路由器中
    用于控制网络和测试
    也可能是默认路由器通过 ICMP 报道的 最佳路由

默认路由
    当在路由表中无法找到下一跳地址， 则发送到默认路由上去
    主机不需要维护过大的路由表， 将功能同一有路由器实现

## 转发流程
主机根据目的ip地址， 计算目的ip地址网络号
    if 为本网络
        直接交付
    else if 为特定路由网络
        转发给特定路由器
    else if 找到了网络号对应的 本网络中的 路由器地址
        转发给该地址的路由器
    else if 存在默认路由
        转发给默认路由
    else
        报告分组转发出错

# ip地址不足问题的解决

## 专用局域网字段
    一个机构内构建局域网， 使用局域网网段的ip地址
    只需申请 几个有 全球ip地址的 路由器和外网连接
    内部网络的机器  通过这些路由器 与外部进行网络连接
    NAT 为这样的功能提供了解决方案

## NAT
    维护自己的 全球ip池, 局域网内的机器轮流使用这些ip

    当有主机有发包需求, 路由器收到数据包, 占用一个未使用的全球ip，记录 内网ip-全球ip 的映射
    将数据包的源地址改为 占用的 全球ip, 将数据报转发出去

    路由器收到一个外部的数据报, 通过查表, 找到当前占用目的地址的 内网机器的 内网ip
    将数据报交付到该机器

    从这可以看出， 虽然解决了ip地址无法分配到每一台机器上的问题， 但是平白无故地增加了 判断， 修改地址的操作.
    用时间换取了空间. 这也是延时高的原因吧. 很多时间用来算地址

    内网的机器, 不能作为服务器在互联网上被访问, 访问者不知道他的地址.
    也就是说， 如果要建立一个提供访问的服务器， 必须被分配一个 全球ip

    NAPT
        网络通信最小单元不是主机, 而是某台主机上的进程(使用 端口号 标识)
        NAPT 结合端口号， 给出更精确的通信映射，
            内网地址：端口号 <=> 全球ip:端口号
        这样, 内网的多台机器可以同时访问同一台机器(的不同端口)
        而单纯是ip地址, 同一时间只能一台机器占用


# 虚拟专用网 VPN
    1. 地域隔离需求. 可以将不同地域的机器组成一个虚拟的网络, 而不需要所有机器集中
    2. 保密需求. 内部机器的通信， 如果经过外部网络， 需要加密不能被外网知道

    位于两个不同区域的机器 A, B 组成的虚拟网络的通信过程
        由于同一网络内的机器通信可以直接交付, 直接用局域网段通信, 即 源地址和目的地址都是局域网的地址

        由于区域的限制, 需要将A， B两个所在的网络的出口路由器 建立一条虚拟的 隧道, 其实就是把A的数据通过外部网络送到B的网络中的路由器RB中, RB再分析出这是一个虚拟网络的地址， 然后再直接交付给B

        A提供 内网通信方式生成的 ip数据报
        RA 分析出B为同一网络， 但是需要通过外网发送. 则将原ip数据报加密, 生成新的报头 再组装成新的数据报
        新的报头
            源地址为 RA地址
            目的地址为B所在网络的路由器RB的 地址
        RB 收到该数据报， 由于知道是RA发过来的并带有标记， 将数据报进行解密， 得到内网通信方式生成的源数据报
        再根据里面的目的地址找到B， 然后交付给B

        核心的内容
            怎么维护两个网络的 隧道
            安全的加密, 解密方式

## 用于去野外的 VPN
    通过VPN的方式, 与野外一台有特殊功能但不是敌人的机器B连接, 建立隧道, 二者可以自由的交换数据
    B能够提供访问代理服务, 也就是A的访问请求都发到B, B完成访问之后再将结果返回给A
    有很多的代理协议; http, https, sock5
